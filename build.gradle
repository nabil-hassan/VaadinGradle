plugins {
    id 'eclipse-wtp'
    id 'java'
    id 'war'
}

group = 'net.example'
version = '1.0-SNAPSHOT'
sourceCompatibility = 1.8
targetCompatibility = 1.8

ext {
	widgetSet = "net.example.MyWidgetSet"
	widgetSetCacheDir = "${rootDir}/build/tmp/gwtCacheDir"
}

repositories {
    jcenter()
    mavenCentral()
}

dependencies {
    compile "org.slf4j:slf4j-api:$slf4jVersion"
    compile "org.slf4j:slf4j-log4j12:$slf4jVersion"
    compile "log4j:log4j:$log4jVersion"
	compile "com.vaadin:vaadin-client:$vaadinVersion"
	compileOnly "com.vaadin:vaadin-client-compiler:$vaadinVersion"
    compile "com.vaadin:vaadin-push:$vaadinVersion"
    compile "com.vaadin:vaadin-server:$vaadinVersion"
    compile "com.vaadin:vaadin-themes:$vaadinVersion"
    compile "javax.servlet:javax.servlet-api:$servletApiVersion"
}

// Cleaning of WidgetSet
def cleanGeneratedWidgetSet() {
	def dir = new File("${rootDir}/src/main/webapp/VAADIN/widgetsets/")
	
	if (dir.exists()) {
		ant.delete (includeEmptyDirs: 'true') {
			fileset(dir: "${rootDir}/src/main/webapp/VAADIN/widgetsets/", includes: "**/*", defaultexcludes: "false")
		}
	}
}

clean {
    cleanGeneratedWidgetSet()
}

task cleanWidgetSet(description: 'Removes all generated source files associated with the project Vaadin widget set', 
                    group: 'build') << {
	cleanGeneratedWidgetSet()
}

// Generation of Widget Set
task createWidgetSetCacheDir(description: 'Creates a directory to cache temporary content in during Vaadin widget set generation', 
                             group: 'build') << {
	File dir = new File(project.widgetSetCacheDir)
	
	if (!dir.exists()) {
		dir.mkdirs()
	}
}

task generateWidgetSet(description: 'Generates the Vaadin widget set specified by property project.widgetset',
                       dependsOn: 'createWidgetSetCacheDir',
                       group: 'build', 
                       type: JavaExec, ) << {
                       
    args '-war', 'src/main/webapp/VAADIN/widgetsets', '-localWorkers', '8', '-logLevel', 'INFO', project.widgetSet
    classpath = sourceSets.main.compileClasspath + files('src/main/resources', 'src/main/java')
    main = 'com.vaadin.tools.WidgetsetCompiler'
    maxHeapSize = '512M'
}

task wrapper(type: Wrapper) {
    gradleVersion = '3.1'
}